{% extends "user/base_user.html" %} {% block content %}
<header class="header">
  <div class="header-content text-center">
    <h1>Formulir Pemesanan</h1>
    <p>
      <i class="bi bi-headset" style="margin-right: 5px"></i>
      Butuh Bantuan? Hubungi Kita Sekarang!
    </p>
    <p style="margin-left: 80px">
      <span style="color: #b9d3fa; font-weight: 600">+62 813-6233-8236</span>
      (Telepon atau WhatsApp)
    </p>
  </div>
</header>

<div class="subutama-container" role="main">
  <p class="formlayanan-text-center">
    Silahkan isi formulir pemesanan di bawah ini untuk melakukan pemesanan
    layanan
    <span class="formlayanan-text-highlight">
      {{ selected_paket_nama if selected_paket_nama else 'paket yang dipilih' }}
    </span>
    dengan harga
    <span class="formlayanan-text-highlight">
      Rp{{ selected_paket_harga if selected_paket_harga else '0' }}
    </span>
    dengan
    <span class="formlayanan-text-highlight">pembayaran deposit</span> sebesar
    <span class="formlayanan-text-highlight">
      Rp{{ selected_paket_deposit if selected_paket_deposit else '0' }}
    </span>
    di setiap layanan pilihan kamu
  </p>

  <form
    class="formlayanan-form"
    id="bookingForm"
    action="/booking"
    method="POST"
    enctype="multipart/form-data"
  >
    <input
      type="hidden"
      id="layanan_id"
      name="layanan_id"
      value="{{ selected_layanan_id }}"
    />
    <input
      type="hidden"
      id="paket_id"
      name="paket_id"
      value="{{ selected_paket_id }}"
    />
    <input
      type="hidden"
      id="harga_paket_dasar"
      name="harga_paket_dasar"
      value="{{ selected_paket_harga_raw }}"
    />
    <input
      type="hidden"
      id="deposit_paket_dasar"
      name="deposit_paket_dasar"
      value="{{ selected_paket_deposit_raw }}"
    />
    <input
      type="hidden"
      id="tanggal_pemesanan"
      name="tanggal_pemesanan"
      value=""
    />
    <input
      type="hidden"
      id="biaya_transportasi"
      name="biaya_transportasi"
      value="0"
    />
    <div class="formlayanan-row">
      <div>
        <label for="nama_klien" class="formlayanan-label">
          Nama lengkap klien<span class="formlayanan-required">*</span>
        </label>
        <input
          type="text"
          id="nama_klien"
          name="nama_klien"
          placeholder="Masukkan nama lengkap klien"
          class="formlayanan-input formlayanan-required"
          required
        />
      </div>

      <div>
        <label for="nama_orang_tua" class="formlayanan-label">
          Nama orang tua klien<span class="formlayanan-required">*</span>
        </label>
        <input
          type="text"
          id="nama_orang_tua"
          name="nama_orang_tua"
          placeholder="Masukkan nama orang tua klien"
          class="formlayanan-input formlayanan-required"
          required
        />
      </div>

      <div>
        <label for="email_klien" class="formlayanan-label">
          Email<span class="formlayanan-required">*</span>
        </label>
        <input
          type="email"
          id="email_klien"
          name="email_klien"
          placeholder="Masukkan email klien"
          class="formlayanan-input formlayanan-required"
          required
        />
        <p class="formlayanan-text-xs">Contoh: ovalphoto@gmail.com</p>
      </div>

      <div>
        <label for="telepon_orang_tua" class="formlayanan-label">
          Nomor telepon orang tua klien<span class="formlayanan-required"
            >*</span
          >
        </label>
        <input
          type="text"
          id="telepon_orang_tua"
          name="telepon_orang_tua"
          placeholder="Masukkan nomor telepon orang tua klien"
          class="formlayanan-input formlayanan-required"
          required
        />
        <p class="formlayanan-text-xs">Contoh: +62-861-3409-8790</p>
      </div>

      <div>
        <label for="telepon_klien" class="formlayanan-label">
          Nomor telepon aktif<span class="formlayanan-required">*</span>
        </label>
        <input
          type="text"
          id="telepon_klien"
          name="telepon_klien"
          placeholder="Masukkan nomor telepon aktif klien"
          class="formlayanan-input formlayanan-required"
          required
        />
        <p class="formlayanan-text-xs">Contoh: +62-861-3409-8790</p>
      </div>

      <div>
        <label for="whatsapp_klien" class="formlayanan-label">
          WhatsApp<span class="formlayanan-required">*</span>
        </label>
        <input
          type="text"
          id="whatsapp_klien"
          name="whatsapp_klien"
          placeholder="Masukkan nomor WhatsApp klien"
          class="formlayanan-input formlayanan-required"
          required
        />
        <p class="formlayanan-text-xs">Contoh: +62-861-3409-8790</p>
      </div>

      <div>
        <label for="instagram_klien" class="formlayanan-label">Instagram</label>
        <input
          type="text"
          id="instagram_klien"
          name="instagram_klien"
          placeholder="Masukkan akun instagram klien"
          class="formlayanan-input"
        />
        <p class="formlayanan-text-xs">Contoh: @ovalphoto</p>
      </div>

      <div>
        <label for="facebook_klien" class="formlayanan-label">Facebook</label>
        <input
          type="text"
          id="facebook_klien"
          name="facebook_klien"
          placeholder="Masukkan akun facebook klien"
          class="formlayanan-input"
        />
        <p class="formlayanan-text-xs">Contoh: Oval Photo</p>
      </div>

      <div>
        <label for="formlayanan-tanggal-acara" class="formlayanan-label">
          Tanggal acara/pemotretan<span class="formlayanan-required">*</span>
        </label>
        <div
          style="
            display: flex;
            gap: 10px;
            align-items: center;
            max-width: 500px;
          "
        >
          <input
            type="date"
            class="form-control"
            name="tanggal_mulai_acara"
            id="tanggal_mulai_acara"
            required
            style="
              border: 1px solid #ccc;
              border-radius: 5px;
              padding: 6px 10px;
              width: 140px;
            "
            placeholder="Tanggal Mulai"
            onchange="calculateAdditionalDayCost(); checkFormValidity();"
            oninput="checkFormValidity();"
          />

          <span>-</span>

          <input
            type="date"
            class="form-control"
            name="tanggal_selesai_acara"
            id="tanggal_selesai_acara"
            required
            style="
              border: 1px solid #ccc;
              border-radius: 5px;
              padding: 6px 10px;
              width: 140px;
            "
            placeholder="Tanggal Selesai"
            onchange="calculateAdditionalDayCost(); checkFormValidity();"
            oninput="checkFormValidity();"
          />
        </div>
        <p class="formlayanan-text-xs">Contoh: 01/01/2025 - 03/01/2025</p>
        <p class="formlayanan-text-green">
          Biaya tambah hari: <span id="biayaTambahHari">Rp 0</span>
        </p>
      </div>

      <div>
        <label for="formlayanan-jam-acara" class="formlayanan-label">
          Jam acara/pemotretan<span class="formlayanan-required">*</span>
        </label>
        <div style="display: flex; align-items: center; gap: 6px">
          <input
            type="time"
            class="form-control"
            name="jam_acara"
            id="jam_acara"
            required
            style="
              border: 1px solid #ccc;
              border-radius: 5px;
              padding: 6px 10px;
              width: 90px;
            "
            oninput="checkFormValidity();"
          />
          <span class="formlayanan-text-xs">WIB</span>
        </div>
        <p class="formlayanan-text-xs">Contoh: 12:30 WIB</p>
      </div>

      <div class="formlayanan-radio-group">
        <p class="formlayanan-label">
          Apakah lokasi acara/pemotretan kamu berada di luar Kab. Labuhanbatu
          Selatan?
          <span class="formlayanan-required">*</span>
        </p>
        <label class="formlayanan-radio-label">
          <input
            type="radio"
            name="lokasi_luar"
            value="iya"
            class="formlayanan-required"
            onchange="handleLokasiLuarChange(); checkFormValidity();"
            required
          />
          <div>
            <span class="formlayanan-text-bold">Iya, berada di luar</span><br />
            <span class="formlayanan-radio-desc">
              Ket: ada biaya tambahan transportasi dan akomodasi yang akan
              diinformasikan melalui riwayat pemesanan kamu
            </span>
          </div>
        </label>

        <label class="formlayanan-radio-label">
          <input
            type="radio"
            name="lokasi_luar"
            value="tidak"
            class="formlayanan-required"
            onchange="handleLokasiLuarChange(); checkFormValidity();"
            required
          />
          <div>
            <span class="formlayanan-text-bold">Tidak</span><br />
            <span class="formlayanan-radio-desc">
              Ket: tidak ada biaya tambahan transportasi dan akomodasi
            </span>
          </div>
        </label>
      </div>
    </div>

    <div class="formlayanan-row">
      <div>
        <label for="lokasiSelect" class="formlayanan-label">
          Lokasi acara/pemotretan<span class="formlayanan-required">*</span>
        </label>
        <select
          id="lokasiSelect"
          name="lokasi_id"
          onchange="displayLokasiPrice(); checkFormValidity();"
          class="formlayanan-select formlayanan-required"
          required
        >
          <option value="" disabled>Pilih lokasi dari daftar</option>
          {% for lokasi in lokasi_list %}
          <option value="{{ lokasi._id|string }}">{{ lokasi.nama }}</option>
          {% endfor %}
          <option value="pilih_lokasi_sendiri" selected>
            Pilih lokasi saya sendiri
          </option>
        </select>
        <p class="formlayanan-text-green">
          Biaya lokasi (biaya tambahan): <span id="biayaLokasi">Rp 0</span>
        </p>
      </div>
    </div>

    <div class="formlayanan-row">
      <div>
        <label for="alamat_lokasi_manual" class="formlayanan-label">
          Alamat lokasi acara/pemotretan<span class="formlayanan-required"
            >*</span
          >
        </label>
        <textarea
          id="alamat_lokasi_manual"
          name="alamat_lokasi_manual"
          rows="5"
          placeholder="Masukan alamat lokasi pemotretan/acara kamu"
          class="formlayanan-textarea formlayanan-required"
          oninput="checkFormValidity()"
        ></textarea>
        <p class="formlayanan-text-xs">Isikan alamat dengan lengkap</p>
      </div>

      <div>
        <label for="link_maps_manual" class="formlayanan-label"
          >Link maps</label
        >
        <textarea
          id="link_maps_manual"
          name="link_maps_manual"
          rows="5"
          placeholder="Masukan link maps dari lokasi pemotretan/acara kamu"
          class="formlayanan-textarea"
        ></textarea>
        <p class="formlayanan-text-xs">
          Contoh: https://maps.app.goo.gl/F28Y86DMYdHLySvT7
        </p>
      </div>

      <div>
        <p
          for="surat_izin_lokasi"
          class="formlayanan-label"
          style="margin-bottom: 12px"
        >
          Unggah surat perizinan lokasi acara/pemotretan kamu!
        </p>
        <div style="max-width: 500px">
          <div
            id="file-display-container-wrapper"
            style="
              display: flex;
              justify-content: center;
              align-items: center;
              gap: 8px;
              border: 1px solid #4da6ff;
              border-radius: 8px;
              padding: 10px;
              cursor: pointer;
              max-width: 500px;
            "
          >
            <input
              type="file"
              id="surat_izin_lokasi_input"
              name="surat_izin_lokasi"
              style="display: none"
              accept=".doc,.docx,.pdf,image/jpeg,image/jpg,image/png"
              onchange="displayFileName(); checkFormValidity();"
            />
            <span
              id="file-icon"
              onclick="document.getElementById('surat_izin_lokasi_input').click();"
              style="font-size: 14px; color: #4da6ff"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                fill="currentColor"
                viewBox="0 0 16 16"
              >
                <path
                  d="M.5 9.9V14a1 1 0 0 0 1 1h13a1 1 0 0 0 1-1V9.9a.5.5 0 0 0-1 0V14a.5.5 0 0 1-.5.5H1.5a.5.5 0 0 1-.5-.5V9.9a.5.5 0 0 0-1 0z"
                />
                <path
                  d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 1 1-.708.708L8.5 2.707V10.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"
                />
              </svg>
            </span>
            <span
              id="file-name"
              onclick="document.getElementById('surat_izin_lokasi_input').click();"
              style="font-size: 14px; color: #4da6ff"
            >
              Tambahkan surat perizinan lokasi kamu di sini
            </span>
            <span
              id="clear-file-btn"
              style="cursor: pointer; display: none; margin-left: auto"
              onclick="clearFileSelection(event);"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-x-circle-fill"
                viewBox="0 0 16 16"
              >
                <path
                  d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"
                />
              </svg>
            </span>
          </div>
        </div>
        <p class="formlayanan-text-xs" style="margin-top: 0.25rem">
          Upload 1 file yang didukung: doc, docx, pdf, gambar (JPEG, JPG dan
          PNG)
        </p>
      </div>
    </div>

    <div style="margin-top: 10px">
      <label style="font-weight: bold; font-size: medium"
        >Total Pembayaran</label
      >
      <label id="totalPembayaran" style="font-weight: bold; font-size: medium"
        >Rp 0</label
      >
      <input type="hidden" id="hiddenTotalHarga" name="total_harga" value="0" />
      <input
        type="hidden"
        id="hiddenDepositPaket"
        name="deposit_paket_akhir"
        value="0"
      />
      <input type="hidden" id="hiddenSisaBayar" name="sisa_bayar" value="0" />
    </div>
    <div class="formlayanan-buttons">
      <button
        type="button"
        class="formlayanan-btn formlayanan-btn-kembali"
        onclick="window.history.back();"
      >
        Kembali
      </button>

      <button
        type="submit"
        id="submitButton"
        class="formlayanan-btn formlayanan-btn-pesan"
        disabled
      >
        Pesan
      </button>
    </div>
  </form>

  <tr>
    <td></td>
    <td></td>
  </tr>
</div>

<div class="subutama-container">
  <main class="container-catatan" role="main" aria-label="Catatan Penting">
    <div class="header-label-catatan" aria-label="Catatan Penting">
      Catatan Penting<span class="text-red-catatan">!!</span>
    </div>

    <ol class="catatan">
      <li class="catatan">
        Simbol bintang (<span class="text-red-catatan">*</span>) menandakan
        bahwa kolom isian wajib diisikan.
      </li>

      <li class="catatan">
        Lokasi pemotretan/acara yang direkomendasikan oleh Oval Photo memiliki
        biaya tambahan, kecuali untuk lokasi ‘Pilihan Saya Sendiri’.
      </li>

      <li class="catatan">
        Pesanan yang berhasil terkirim akan dilakukan pemeriksaan selama 1 x 24
        jam. Pastikan selalu memeriksa riwayat pesanan kamu dan lakukan
        pembayaran deposit setelah pesanan kamu dikonfirmasi.
      </li>

      <li class="catatan">
        Klien wajib membayar deposit sebagai tanda jadi atas layanan dan paket
        yang dipilih, sebesar:
        <ul class="catatan">
          <li class="catatan">
            Rp500.000 untuk layanan paket enggagement I, semua paket layanan
            prewedding, dan semua paket layanan wedding, atau
          </li>
          <li class="catatan">Rp200.000 untuk layanan paket enggagement II</li>
        </ul>
        Sisa pembayaran (pelunasan) dapat dibayar setelah sesi pemotretan
        selesai atau setelah pembayaran deposit melalui menu ‘Riwayat
        Pemesanan’.
      </li>

      <li class="catatan">
        Link Google Drive yang berisi
        <span class="text-red-catatan"
          >file foto hasil edit akan dikirim dalam 3-5 hari</span
        >
        setelah hari pemotretan yang dapat diakses melalui menu ‘Riwayat
        Pemesanan’, email, dan WhatsApp.
        <span class="text-red-catatan"
          >Album foto akan diproduksi dalam 2-3 minggu</span
        >
        dan akan dikirimkan melalui jasa pengiriman.
      </li>

      <li class="catatan">
        Jadwal pemotretan dapat diubah melalui menu ‘Riwayat Pemesanan’ dengan
        memilih opsi ‘Ubah Jadwal’. Pastikan jadwal yang diinginkan masih
        tersedia dengan memeriksa ketersediaan jadwal di menu ‘Katalog Layanan’.
      </li>

      <li class="catatan">
        Tambah hari dapat dilakukan melalui menu ‘Riwayat Pemesanan’ dengan
        memilih opsi ‘Ubah Jadwal’ dan
        <span class="text-red-catatan"
          >akan dikenakan biaya tambahan sebesar Rp500.000 untuk setiap 1 (satu)
          tambahan hari.</span
        >
      </li>

      <li class="catatan">
        Lokasi acara/pemotretan yang berada di luar Kab. Labuhanbatu Selatan
        akan dikenakan biaya tambahan untuk transportasi dan akomodasi. Oval
        Photo akan menginformasikan biaya tambahan ini melalui telepon atau
        WhatsApp sebelum klien melakukan pembayaran deposit (pastikan nomor yang
        kamu isikan bisa dihubungi ya!). Jika klien menyetujui biaya tambahan
        tersebut, maka jumlahnya akan tercantum pada rincian pembayaran di menu
        'Riwayat Pemesanan'. Namun, jika tidak disetujui, maka pemesanan akan
        dibatalkan.
      </li>

      <li class="catatan">
        Lokasi acara/pemotretan yang memerlukan perizinan, diharapkan untuk
        mengunggah surat perizinan pada formulir pesanan atau pada menu ‘Riwayat
        Pemesanan’ sebelum dilakukan sesi pemotretan.
      </li>

      <li class="catatan">
        Jika kamu memiliki pertanyaan lain seputar layanan fotografi Oval Photo,
        kamu dapat meng-klik
        <a
          href="/formfaq"
          class="faq-btn-catatan"
          role="button"
          aria-label="FAQ"
        >
          <i class="bi bi-question-circle-fill" aria-hidden="true"></i>FAQ
        </a>
        untuk melihat pertanyaan yang serupa dengan yang ingin kamu tanyakan.
        Jika tidak menemukan pertanyaan serupa, maka kamu dapat menanyakannya
        melalui tempat yang sudah disediakan pada halaman ‘FAQ’.
      </li>

      <li class="catatan">
        Jika mengalami kendala yang belum terselesaikan atau membutuhkan bantuan
        serta konsultasi, maka kamu dapat menghubungi nomor +62 813-6233-8236
        (via telepon) atau meng–klik
        <a
          href="https://wa.me/+6281362338236"
          class="whatsapp-btn-catatan"
          role="button"
          aria-label="Konsultasi Sekarang"
        >
          <i class="bi bi-whatsapp" aria-hidden="true"></i>Konsultasi Sekarang
        </a>
      </li>
    </ol>
  </main>
</div>

<style>
  /* Base style for the "Pesan" button when disabled */
  .formlayanan-btn-pesan[disabled] {
    background-color: #cccccc; /* Greyed out color */
    color: #666666; /* Darker text for disabled state */
    cursor: not-allowed;
  }

  /* Style for the "Pesan" button when active (not disabled) */
  .formlayanan-btn-pesan:not([disabled]) {
    background-color: #2b5ea3; /* Blue color as per image */
    color: #ffffff; /* White text color as per image */
    cursor: pointer;
  }

  /* Optional: Add hover effect for active button */
  .formlayanan-btn-pesan:not([disabled]):hover {
    background-color: #244a87; /* Slightly darker blue on hover */
  }
</style>

<script>
  // Global variable to store paket data for easy lookup
  let allPaketData = []; // This variable is not used in the provided JS, consider removing if truly unused.
  let allLokasiData = [];
  const ADDITIONAL_DAY_COST_PER_DAY = 500000;

  document.addEventListener("DOMContentLoaded", function () {
    // Set current date for tanggal_pemesanan
    const today = new Date();
    document.getElementById("tanggal_pemesanan").value = today
      .toISOString()
      .split("T")[0];

    // Fetch all lokasi data
    fetch("/api/all_lokasi")
      .then((response) => response.json())
      .then((data) => {
        allLokasiData = data;
        displayLokasiPrice(); // Call this after lokasi data is loaded
        checkFormValidity(); // Initial check after loading dynamic data
      });

    const form = document.getElementById("bookingForm");
    const submitButton = document.getElementById("submitButton"); // Get the submit button

    // Attach event listeners to all required inputs
    // Re-select required inputs in case displayLokasiPrice changes attributes
    const requiredInputs = form.querySelectorAll("[required]");
    requiredInputs.forEach((input) => {
      input.addEventListener("input", checkFormValidity);
      input.addEventListener("change", checkFormValidity);
    });

    // Special handling for radio buttons
    const radioGroups = document.querySelectorAll('input[name="lokasi_luar"]');
    radioGroups.forEach((radio) => {
      radio.addEventListener("change", checkFormValidity);
    });

    // Special handling for select element
    document
      .getElementById("lokasiSelect")
      .addEventListener("change", checkFormValidity);

    // Initial check for form validity and total calculation on page load
    updateTotalDanSisaBayar();
    checkFormValidity(); // This must be called after all elements are set up.

    // Display initial file name (if any)
    displayFileName();

    // Attach SweetAlert to the form's submit event
    form.addEventListener("submit", function (event) {
      // Prevent default form submission initially
      event.preventDefault();

      // Check form validity using native browser validation
      if (!form.checkValidity()) {
        form.reportValidity(); // Show native validation messages
        return; // Stop if form is not valid
      }

      Swal.fire({
        title: "Sudah yakin melakukan pemesanan?",
        text: "Periksa kembali pesanan kamu dan pastikan tidak ada data yang salah!",
        icon: "question",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Sudah Yakin",
        cancelButtonText: "Periksa Dulu",
      }).then((result) => {
        if (result.isConfirmed) {
          // User clicked "Sudah Yakin"
          // Show success message and then submit the form
          Swal.fire({
            title: "Pesanan kamu berhasil terkirim!",
            text: "Tunggu selama 1 x 24 jam hingga pesanan kamu dikonfirmasi. Setelah itu segera lakukan pembayaran deposit ya! ",
            icon: "success",
            timerProgressBar: true,
            timer: 4000, // Show for 4 seconds
            showConfirmButton: false, // No confirm button
            willClose: () => {
              // Now, actually submit the form after the success message closes
              form.submit(); // <--- MOVED THIS LINE HERE
            },
          });
        }
      });
    });
  });

  function displayLokasiPrice() {
    const lokasiId = document.getElementById("lokasiSelect").value;
    const biayaLokasiSpan = document.getElementById("biayaLokasi");
    const alamatInput = document.getElementById("alamat_lokasi_manual");
    const mapsInput = document.getElementById("link_maps_manual");

    // Clear previous values and required status for manual input
    alamatInput.value = "";
    mapsInput.value = "";
    // Remove 'required' attribute initially
    alamatInput.removeAttribute("required");

    if (lokasiId === "pilih_lokasi_sendiri") {
      alamatInput.setAttribute("required", "true"); // Add required for manual address
      biayaLokasiSpan.innerText = "Rp 0";
    } else {
      const lokasi = allLokasiData.find((loc) => loc._id === lokasiId);
      if (lokasi) {
        biayaLokasiSpan.innerText = formatRupiah(lokasi.biaya);
        alamatInput.value = lokasi.alamat || "";
        mapsInput.value = lokasi.link_maps || "";
      } else {
        biayaLokasiSpan.innerText = "Rp 0"; // Fallback if lokasi not found
      }
    }
    updateTotalDanSisaBayar();
    checkFormValidity();
  }

  function calculateAdditionalDayCost() {
    const startInput = document.getElementById("tanggal_mulai_acara");
    const endInput = document.getElementById("tanggal_selesai_acara");
    const biayaSpan = document.getElementById("biayaTambahHari");
    let additionalCost = 0;

    if (startInput.value && endInput.value) {
      const start = new Date(startInput.value);
      const end = new Date(endInput.value);

      if (end >= start) {
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        // Only charge for days beyond the first one (diffDays will be 0 for one day)
        // If diffDays is 0, it means 1 day of service (start and end are the same day)
        // So, additional cost is for days > 1.
        additionalCost =
          diffDays > 0 ? diffDays * ADDITIONAL_DAY_COST_PER_DAY : 0;
      }
    }
    biayaSpan.innerText = formatRupiah(additionalCost);
    updateTotalDanSisaBayar();
    checkFormValidity();
  }

  function updateTotalDanSisaBayar() {
    // Get base price and deposit from hidden fields
    const hargaPaket =
      parseFloat(document.getElementById("harga_paket_dasar").value) || 0;
    const depositDasar =
      parseFloat(document.getElementById("deposit_paket_dasar").value) || 0;

    const biayaTambahHari =
      parseInt(
        document.getElementById("biayaTambahHari").innerText.replace(/\D/g, "")
      ) || 0;
    const biayaLokasi =
      parseInt(
        document.getElementById("biayaLokasi").innerText.replace(/\D/g, "")
      ) || 0;

    // biaya_transportasi is expected to be 0 for now as per the note,
    // it will be updated by admin. So, it's not dynamically calculated here.
    const biayaTransportasi = 0; // This will be set by admin later

    const total =
      hargaPaket + biayaTambahHari + biayaLokasi + biayaTransportasi;
    const sisa = total - depositDasar;

    document.getElementById("totalPembayaran").innerText = formatRupiah(total);
    document.getElementById("hiddenTotalHarga").value = total;
    document.getElementById("hiddenDepositPaket").value = depositDasar; // Ensure deposit sent is the base deposit
    document.getElementById("hiddenSisaBayar").value = sisa;
  }

  function formatRupiah(amount) {
    return new Intl.NumberFormat("id-ID", {
      style: "currency",
      currency: "IDR",
      minimumFractionDigits: 0,
    }).format(amount);
  }

  function displayFileName() {
    const fileInput = document.getElementById("surat_izin_lokasi_input");
    const fileNameSpan = document.getElementById("file-name");
    const clearFileBtn = document.getElementById("clear-file-btn");
    const fileIcon = document.getElementById("file-icon");

    if (fileInput.files.length > 0) {
      fileNameSpan.textContent = fileInput.files[0].name;
      clearFileBtn.style.display = "inline-block";
      fileIcon.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-file-earmark" viewBox="0 0 16 16">
            <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-3z"/>
        </svg>
      `;
    } else {
      fileNameSpan.textContent =
        "Tambahkan surat perizinan lokasi kamu di sini";
      clearFileBtn.style.display = "none";
      fileIcon.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M.5 9.9V14a1 1 0 0 0 1 1h13a1 1 0 0 0 1-1V9.9a.5.5 0 0 0-1 0V14a.5.5 0 0 1-.5.5H1.5a.5.5 0 0 1-.5-.5V9.9a.5.5 0 0 0-1 0z"/>
            <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 1 1-.708.708L8.5 2.707V10.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
        </svg>
      `;
    }
  }

  function clearFileSelection(event) {
    event.stopPropagation(); // Prevent triggering the input click
    const fileInput = document.getElementById("surat_izin_lokasi_input");
    fileInput.value = "";
    displayFileName();
    checkFormValidity();
  }

  function handleLokasiLuarChange() {
    // No dynamic change to biaya_transportasi here, it's informed by admin later.
    // This function primarily exists to trigger checkFormValidity when radio changes.
    checkFormValidity();
  }

  function checkFormValidity() {
    const form = document.getElementById("bookingForm");
    const submitButton = document.getElementById("submitButton");
    let allRequiredFilled = true;

    // List of specific required fields that must be filled
    const requiredFieldIds = [
      "nama_klien",
      "nama_orang_tua",
      "email_klien",
      "telepon_orang_tua",
      "telepon_klien",
      "whatsapp_klien",
      "tanggal_mulai_acara",
      "tanggal_selesai_acara",
      "jam_acara",
    ];

    requiredFieldIds.forEach((id) => {
      const input = document.getElementById(id);
      if (input && !input.value.trim()) {
        allRequiredFilled = false;
      }
    });

    // Check radio group for 'lokasi_luar'
    const radioLokasiLuar = document.querySelector(
      'input[name="lokasi_luar"]:checked'
    );
    if (!radioLokasiLuar) {
      allRequiredFilled = false;
    }

    // Check 'lokasiSelect'
    const lokasiSelect = document.getElementById("lokasiSelect");
    // Ensure that if "Pilih lokasi dari daftar" is selected, it's not the disabled empty option
    if (
      !lokasiSelect ||
      lokasiSelect.value === "" ||
      lokasiSelect.value === "Pilih lokasi dari daftar"
    ) {
      allRequiredFilled = false;
    }

    // Conditional check for 'alamat_lokasi_manual'
    const alamatLokasiManual = document.getElementById("alamat_lokasi_manual");
    if (
      lokasiSelect &&
      lokasiSelect.value === "pilih_lokasi_sendiri" &&
      !alamatLokasiManual.value.trim()
    ) {
      allRequiredFilled = false;
    }

    // Update button disabled state
    submitButton.disabled = !allRequiredFilled;
  }
</script>

{% endblock %}
